<?php
 namespace Dompdf\Image; use Dompdf\Dompdf; use Dompdf\Helpers; use Dompdf\Exception\ImageException; class Cache { protected static $_cache = array(); public static $broken_image = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABABAMAAABYR2ztAAAAA3NCSVQICAjb4U/gAAAAHlBMVEWZmZn////g4OCkpKS1tbXv7++9vb2tra3m5ub5+fkFnN6oAAAACXBIWXMAAAsSAAALEgHS3X78AAAAHHRFWHRTb2Z0d2FyZQBBZG9iZSBGaXJld29ya3MgQ1M0BrLToAAAABZ0RVh0Q3JlYXRpb24gVGltZQAwNC8xMi8xMRPnI58AAAGZSURBVEiJhZbPasMwDMbTw2DHKhDQcbDQPsEge4BAjg0Mxh5gkBcY7Niwkpx32PvOjv9JspX60It/+fxJsqxW1b11gN11rA7N3v6vAd5nfR9fDYCTDiyzAeA6qgKd9QDNoAtsAKyKCxzAAfhdBuyHGwC3oovNvQOaxxJwnSNg3ZQFAlBy4ax7AG6ZBLrgA5Cn038SAPgREiaJHJASwXYEhEQQIACyikTTCWCBJJoANBfpPAKQdBLHFMBYkctcBKIE9lAGggt6gRjgA2GV44CL7m1WgS08fAAdsPHxyyMAIyHujgRwEldHArCKy5cBz90+gNOyf8TTyKOUQN2LPEmgnWWPcKD+sr+rnuqTK1avAcHfRSv3afTgVAbqmCPiggLtGM8aSkBNOidVjADrmIDYebT1PoGsWJEE8Oc0b96aZoe4iMBZPiADB6RAzEUA2vwRmyiAL3Lfv6MBSEmUEg7ALt/3LhxwLgj4QNw4UCbKEsaBNpPsyRbgVRASFig78BIGyJNIJQyQTwIi0RvgT98H+Mi6W67j3X8H/427u5bfpQGVAAAAAElFTkSuQmCC"; protected static $_dompdf; static function resolve_url($url, $protocol, $host, $base_path, Dompdf $dompdf) { self::$_dompdf = $dompdf; $protocol = mb_strtolower($protocol); $parsed_url = Helpers::explode_url($url); $message = null; $remote = ($protocol && $protocol !== "file://") || ($parsed_url['protocol'] != ""); $data_uri = strpos($parsed_url['protocol'], "data:") === 0; $full_url = null; $enable_remote = $dompdf->getOptions()->getIsRemoteEnabled(); try { if (!$enable_remote && $remote && !$data_uri) { throw new ImageException("Remote file access is disabled.", E_WARNING); } else { if ($enable_remote && $remote || $data_uri) { $full_url = Helpers::build_url($protocol, $host, $base_path, $url); if (isset(self::$_cache[$full_url])) { $resolved_url = self::$_cache[$full_url]; } else { $tmp_dir = $dompdf->getOptions()->getTempDir(); $resolved_url = tempnam($tmp_dir, "ca_dompdf_img_"); $image = ""; if ($data_uri) { if ($parsed_data_uri = Helpers::parse_data_uri($url)) { $image = $parsed_data_uri['data']; } } else { $image = wp_remote_get( $full_url, array( 'method' => 'GET', 'timeout' => 45, 'redirection' => 5, 'httpversion' => '1.0', 'blocking' => true, 'sslverify' => false, ) ); if ( is_wp_error($image)) { error_log($image->get_error_message()); die($image->get_error_message()); } $image = isset($image['body']) ? $image['body'] : ''; restore_error_handler(); } if (strlen($image) == 0) { $msg = ($data_uri ? "Data-URI could not be parsed" : "Image not found"); throw new ImageException($msg, E_WARNING); } else { file_put_contents($resolved_url, $image); } } } else { $resolved_url = Helpers::build_url($protocol, $host, $base_path, $url); } } if (!is_readable($resolved_url) || !filesize($resolved_url)) { throw new ImageException("Image not readable or empty", E_WARNING); } else { list($width, $height, $type) = Helpers::dompdf_getimagesize($resolved_url, $dompdf->getHttpContext()); if ($width && $height && in_array($type, array("gif", "png", "jpeg", "bmp", "svg"))) { if ($enable_remote && $remote || $data_uri) { self::$_cache[$full_url] = $resolved_url; } } else { throw new ImageException("Image type unknown", E_WARNING); } } } catch (ImageException $e) { $resolved_url = self::$broken_image; $type = "png"; $message = "Image not found or type unknown"; Helpers::record_warnings($e->getCode(), $e->getMessage() . " \n $url", $e->getFile(), $e->getLine()); } return array($resolved_url, $type, $message); } static function clear() { if (empty(self::$_cache) || self::$_dompdf->getOptions()->getDebugKeepTemp()) { return; } foreach (self::$_cache as $file) { if (self::$_dompdf->getOptions()->getDebugPng()) { print "[clear unlink $file]"; } unlink($file); } self::$_cache = array(); } static function detect_type($file, $context = null) { list(, , $type) = Helpers::dompdf_getimagesize($file, $context); return $type; } static function is_broken($url) { return $url === self::$broken_image; } } if (file_exists(realpath(__DIR__ . "/../../lib/res/broken_image.png"))) { Cache::$broken_image = realpath(__DIR__ . "/../../lib/res/broken_image.png"); }